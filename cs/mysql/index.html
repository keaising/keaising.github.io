<!DOCTYPE html>
<html lang="zh-Hans" class="han-init">

<head>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>流水沉微 - MySQL</title>
    <link rel="stylesheet" href="/assets/han.css">
    <link rel="stylesheet" href="/assets/normalize.css">
    <link rel="stylesheet" href="/assets/style.css">
    <link rel="stylesheet" href="/assets/syntax.css">
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.11.2/css/all.css">
    <script src="/assets/anchor.min.js"></script>
</head>

<body>
    <div class="content index width mx-auto px2 my4">
        <div class="top-header">
  <a class="site-title" href="http://shuxiao.wang">
    流水沉微
  </a>

  
  
  <div class="nav-body">
    
    
    <a class="nav-item " href="/posts/">
      
      <span>Posts</span>
    </a>
    
    
    
    <a class="nav-item " href="/cloud/">
      
      <span>Cloud</span>
    </a>
    
    
    
    <a class="nav-item " href="/eureka/">
      
      <span>Eureka!</span>
    </a>
    
    
  </div>
  
</div>

        <div>
            


<div class="Subhead">
    <div class="Subhead-heading">
        <h1>MySQL</h1>
    </div>
</div>




<article>
    
    <div>
        

<h2 id="事务">事务</h2>

<h3 id="隔离级别-1">隔离级别[1]</h3>

<table>
<thead>
<tr>
<th>隔离级别</th>
<th align="center">脏读可能性</th>
<th align="right">不可重复读可能性</th>
<th align="right">幻读可能性</th>
<th align="right">加锁读</th>
</tr>
</thead>

<tbody>
<tr>
<td>读未提交 Read uncommitted</td>
<td align="center">○</td>
<td align="right">○</td>
<td align="right">○</td>
<td align="right">○</td>
</tr>

<tr>
<td>读已提交 Read committed</td>
<td align="center">×</td>
<td align="right">○</td>
<td align="right">○</td>
<td align="right">○</td>
</tr>

<tr>
<td>可重复读 Repeatable read</td>
<td align="center">×</td>
<td align="right">×</td>
<td align="right">○</td>
<td align="right">×</td>
</tr>

<tr>
<td>串行化 Serializable</td>
<td align="center">×</td>
<td align="right">×</td>
<td align="right">×</td>
<td align="right">○</td>
</tr>
</tbody>
</table>

<blockquote>
<p><strong>读未提交 Read uncommitted</strong></p>
</blockquote>

<p>事务中的修改即使没有提交，对其他事务也是可见的</p>

<p>事务可以读取到未提交的数据，被称为脏读</p>

<p>性能并不比其他级别好很多，但是问题多多，一般不用</p>

<blockquote>
<p><strong>读已提交 Read committed</strong></p>
</blockquote>

<p>事务开始时，只能看见已经提交了的事务所做的修改</p>

<p>事务从开始到直到提交之前，其所做的修改对其他事务来说是不可见的</p>

<p>问题：可能会产生不可重复读的问题，因为两次执行同样的查询，可能得到不同的结果</p>

<p>场景：事务A执行过程中先后查询了两次，事务B在事务A的两次查询之间修改了符合事务A的查询条件的记录，导致事务A中的两次查询结果不同</p>

<blockquote>
<p><strong>可重复读 Repeatable read（MySQL的默认事务隔离级别）</strong></p>
</blockquote>

<p>可重复读解读了脏读和不可重复读的问题，保证了同一个事务中多次读取同样记录的结果一致，但是不能解决幻读（Phantom Read）的问题</p>

<p>幻读：当事务A在读取某个范围内的记录时，另一个事务又在这个范围内插入了新的记录，当之前的事务再次读取该范围的记录时，会产生幻行</p>

<p>场景：事务A先查询了数据库中最大的ID为9，于是给自己将要插入的数据的ID设为10，在事务A进行过程中，事务B先插入了一个ID为10的记录，事务A在插入过程中报错，因为INSERT也是一次隐式的读取</p>

<p>InnoDB和XtraDB通过MVCC解决了读数据情况下的幻读问题，对于修改和新增依然存在幻读，于是又发展了next-key locking来处理修改和新增场景下的幻读，当前的MySQL应该是没有幻读问题的</p>

<blockquote>
<p><strong>串行化 Serializable</strong></p>
</blockquote>

<p>Serializable 是最高隔离级别，所有事务串行执行</p>

<p>Serializable 会在所读取的每一行数据上都加锁</p>

<p>可能导致大量的超时和锁争用的情况，需要保证强一致性和可以接受没有并发的情况下使用</p>

<h3 id="mvcc">MVCC</h3>

<p>MVCC只在Repeatable read和Read committed两个隔离级别下工作</p>

<p>Read uncommitted永远只读最新版本，而不是符合当前事务版本的数据行，Serializable会对所有的读数据加锁</p>

<blockquote>
<p><strong>版本号[2]</strong></p>
</blockquote>

<ol>
<li><p>系统版本号：一个递增的数字，每开始一个新的事务，系统版本号就会自动递增</p></li>

<li><p>事务版本号：事务开始时的系统版本号</p></li>
</ol>

<h4 id="select">SELECT</h4>

<p>select时读取数据的规则为：</p>

<ol>
<li><p>创建版本号&lt;=当前事务版本号</p></li>

<li><p>删除版本号为空或&gt;当前事务版本号</p></li>
</ol>

<p>创建版本号&lt;=当前事务版本号保证取出的数据不会有后启动的事务中创建的数据</p>

<p>删除版本号为空或&gt;当前事务版本号保证了至少在该事务开启之前数据没有被删除，是应该被查出来的数据。</p>

<h4 id="insert">INSERT</h4>

<p>为新插入的每一行保存当前系统版本号作为行版本号</p>

<h4 id="update">UPDATE</h4>

<p>插入一条新纪录，保存当前事务版本号为行创建版本号</p>

<p>同时保存当前系统版本号到原来的行作为行删除版本号</p>

<h4 id="delete">DELETE</h4>

<p>为删除的每一行保存当前系统版本号作为行删除版本号</p>

<h2 id="参考文献">参考文献</h2>

<p>[1] 高性能MySQL 第三版 P8 事务隔离级别 /P12 MVCC <a href="https://book.douban.com/subject/23008813/">豆瓣读书</a></p>

<p>[2] MySQL的可重复读级别能解决幻读吗 <a href="https://juejin.im/post/5c9040e95188252d92095a9e">掘金</a></p>

    </div>

    <div class="page-info">
        <div>
            

<div>
    
</div>





        </div>
        
            
                <div class="publish-date">
                    <span
                        title="Lastmod: 2017-01-01. Published at: 2017-01-01.">
                        1 Jan 2017
                    </span>
                </div>
            
        
    </div>
</article>





        </div>
        <div id="footer" class="pt-2 pb-3 bg-white text-center">
            

  <span class="text-small text-gray">
    

    Powered by the
    <a href="https://github.com/keaising/kitto" class="link-gray-dark">Kitto</a> theme for
    <a href="https://gohugo.io" class="link-gray-dark">Hugo</a>.
  </span>


        </div>
    </div>

    
    <script>anchors.add();</script>
    <script type="text/javascript"
        src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <script type="text/javascript" src="/assets/han.js"></script>
    
    <script type="text/x-mathjax-config">MathJax.Hub.Config({ tex2jax: { inlineMath: [['$','$'], ['\\(','\\)']] } });
    </script>
    <script>
        anchors.options = {
            placement: 'left',
        };
        anchors.add();
        anchors.add(".tag-title-left");
      </script>
</body>

</html>